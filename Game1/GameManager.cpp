#include "GameManager.h"
#include "Pokemon/Pikachu.h"
#include "Pokemon/Kkobugi.h"
#include "Pokemon/Pairi.h"
#include "Pokemon/Naong.h"
#include "Pokemon/Majayong.h"
#include "Pokemon/Ttodogas.h"
#include "Tools.h"

void GameManager::init()
{
    gameState_ = GameState::MENU; 
    stageNumber_ = 1; 
    battleManager_.init();
}

void GameManager::menu()
{
    std::cout << "===== 게임 메뉴 =====\n";
    std::cout << "1. 전투 시작\n";
    std::cout << "2. 게임 종료\n";
    std::cout << "번호를 선택하세요: ";

    int input = 0;
    std::cin >> input;

    switch (input) {
    case 1:
        gameState_ = GameState::BATTLE;
        selectCharacter();
        startBattle();
        system("cls");
        break;
    case 2:
        gameState_ = GameState::EXIT;
        break;
    default:
        std::cout << "잘못된 입력입니다.\n";
        break;
    }
}

void GameManager::startBattle()
{
    battleManager_.init();
}

void GameManager::update()
{
    switch (gameState_) {
    case GameState::MENU:
        system("cls");
        menu();
        break;

    case GameState::BATTLE:
        std::cout << "전투 시작!!\n";
        Sleep(1000);
        battleManager_.executeBattle();
        if (battleManager_.getLastResult() == BattleResult::COMPUTER_WIN) {
            std::cout << "Game Over! You lost.\n";
            Sleep(2000);
            gameState_ = GameState::MENU;
        } else if (battleManager_.getLastResult() == BattleResult::PLAYER_WIN) {
            std::cout << "You Win! Proceeding to next stage...\n";
            Sleep(2000);
            // Advance to next stage

   
        }
        break;

    case GameState::EXIT:
        std::cout << "게임을 종료합니다.\n";
        Sleep(2000);
        exit(0);
        break;
    }
}

void GameManager::selectCharacter()
{
    Pokemon* playerPokemon = nullptr;
    Pokemon* opponentPokemon = new Naong(Position(1, 3));

    unsigned int choice = 3;
    while (choice > 2) {

        system("cls");
        cout << "캐릭터를 선택하세요.\n";
        cout << "\
0. Pikachu\n\
1. Kkobugi\n\
2. Pairi\n";
        cin >> choice;

        Position playerStPos = Position(1, 0);

        switch (choice) {
        case 0:
            playerPokemon = new Pikachu(playerStPos);
            break;
        case 1:
            playerPokemon = new Kkobugi(playerStPos);
            break;
        case 2:
            playerPokemon = new Pairi(playerStPos);
            break;
        default:
            system("cls");
            cout << "유효하지 않은 입력 입니다.\n";
            Sleep(2000);
            break;
        }
    }

    string name = typeid(*playerPokemon).name();
    cout << "\nSelected Pokemon : " << name << endl;
    Sleep(1000);

    battleManager_.setHumanPokemon(playerPokemon);
    battleManager_.setComputerPokemon(opponentPokemon);
}
